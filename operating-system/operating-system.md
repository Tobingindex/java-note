# Operating-System

## 操作系统概述

### 系统职责

操作系统主要有两个职责：对硬件进行管理和抽象，为应用提供服务并进行管理。

从硬件层面，操作系统需要包含两类功能：

+ 将复杂的、具备不同功能的硬件资源纳入统一的管理
+ 负责将硬件抽象成不依赖具体硬件特性的资源，核心是「将有限的、离散的资源高效地抽象为无线的、连续的资源」

从应用层面，操作系统主要包含两类功能：

+ 提供不同层次、不同功能的接口以满足应用的需求，提供不同类型的访问控制、应用间交互
+ 操作系统负责对应用生命周期进行管理，包含应用的加载、启动、切换、调度、销毁等

### 操作系统接口

从应用角度、操作系统需要提供不同的层次接口，主要包含了系统调用接口、POSIX接口、领域引用接口。

**系统调用接口**

应用程序通过操作系统内核提供的接口向内核申请服务，如**系统调用**。系统调用是用户态应用向操作系统内核请求服务的方法。

**POSIX接口**

POSIX，Portable Operating System Interface for uniX，可移植操作系统接口。

由于每个操作系统提供的系统调用各不相同，为了同一个应用程序在不同操作系统上的可移植性，逐渐形成了一些可移植的操作系统接口标准，其中包含了POSIX。

**领域应用接口**

在POSIX或操作系统调用之上面向不同领域的领域应用接口。

### 硬件结构

现在主流计算机采用的硬件结构是冯诺依曼结构。在冯诺依曼结构中主要包括三个主要部分。

+ 中央处理器：主要负责运算和逻辑控制。
+ 存储器：负责储存程序指令和数据，以及保存程序执行的中间结果。通常包括寄存器、CPU缓存、内存等。
+ 输入输出：负责与外界打交道，从外界获取输入，并将结果向外界输出。

CPU与软件之间的桥梁是指令集架构。指令集架构主要包含了指令集、特权级、寄存器、执行模式、安全扩展、性能加速扩展等诸多方面。

**指令集**

指令集通常包含一系列不同功能的指令，用于数据搬移、计算、内存访问、过程调用等。CPU在运行操作系统或应用程序时，实际上是执行它们被编译之后包含的指令。

**特权级**

为了隔离不同功能之间造成的影响，指令集往往会提供不同的特权级。常见的特权级有用户态和内核态。对系统功能进行用户态和内核态的拆分，可以使得在用户态程序发生奔溃时，不会或很难影响到内核态程序的正常执行，从而显著提高了操作系统的安全性与可靠性。

从用户态切换到内核态的常用场景有三种：

+ 应用程序需要调用操作系统提供的系统调用【同步】
+ 应用程序会执行了一条指令，而该指令触发了异常，如应用执行访存指令时，触发了缺页异常【同步】
+ 应用程序执行过程汇总，CPU收到了一个来自外设的中断【异步】

> 同步的CPU特权级切换是由CPU正在执行的指令导致；异步的CPU特权级切换是不是由CPU运行的应用程序的指令导致

在发生特权级切换时，CPU和操作系统需要共同协作，主要流程如下：

1. CPU读取向量基地址寄存器，获得**异常向量表**的基地址
2. 根据异常原因调用操作系统设置的相应异常处理函数
3. 执行相应函数前一般会保护应用程序的上下文
4. 执行相应的异常处理函数
5. 执行完毕操作系统会恢复应用程序的上下文返回

> 为了能够在处理异常时，应用程序信息不被破坏，CPU会应用程序的执行状态进行保存，状态信息主要包含了：程序计数器、异常原因、栈指针、程序状态字寄存器、错误地址寄存器等。

**物理内存与缓存**

与CPU处理速度相比，内存的访问速度较慢。为了降低CPU访存的开销 ，现代CPU中一般引入了缓存，用于存放部分物理内存中的数据。

当CPU需要向物理内存写入数据时，可以直接在CPU缓存中；

当CPU需要从物理内存中读取数据时，可以先在CPU缓存中查找；

如果没有再到物理内存中获取，并把取回的数据放入缓存中，以便加快下次读取的速度。

**设备与中断**

输入输出设备的种类繁多、功能丰富，是冯诺依曼中的主要组成部分。输入输出设备与CPU之间的交互方式主要有以下几种方式。

+ 内存映射输入输出(MMIO)：一种常见的CPU控制和访问设备的方式，原理是把输入输出设备和物理内存放到同一个地址空间，为设备内部的内存和寄存器也分配相应的地址。
+ 轮询：CPU不通过MMIO查看是否有响应的输入，这种会浪费CPU资源
+ 中断：设备通过向CPU发出中断来打断CPU执行，使得CPU处理这个中断













