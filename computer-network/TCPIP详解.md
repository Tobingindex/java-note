# TCP/IP详解

## 概述

网络协议通常分成不同层次进行开发，每一层负责不同的通信功能。TCP/IP是一个四层的协议系统，每一层负责不同的功能：

+ 链路层：包括操作系统中设备驱动程序和计算机中对应的网络接口卡。它们一起处理电缆的网络接口细节；
+ 网络层：处理分组在网络中的活动，如分组的选路。网络层包括：IP协议、ICMP协议、IGMP协议；
+ 运输层：为两台计算机的应用进程提供端到端的通信。运输层包含：TCP和UDP协议；
  + TCP为主机之间提供高可靠的数据通信，负责将应用程序交给它的数据分成合适大小块交个下面网络层，确认收到的分组，设置发送最后确认分组的超时时钟；
  + UDP为应用层提供一种简单的服务，只是把称为数据报的分组从一台主机发送到另一台主机，不保证数据包能到达另一端。任何必须的可靠性由应用层提供；
+ 应用层：负责处理特定的应用程序细节。TCP/IP实现提供了通用的应用程序：Telnet、FTP、SMTP、SNMP。

### TCP/IP的分层

TCP/IP具有多种协议，下面主要展示了不同层次的具有的协议。

![image-20210905190119053](https://gitee.com/tobing/imagebed/raw/master/image-20210905190119053.png)

+ TCP和UDP是著名的运输层协议，它们都使用IP作为网络层协议；
+ IP是网络层的主要协议；
+ ICMP是IP协议的附属协议，IP层用它来与其他主机和或路由器交换错误报文或其他重要信息。
+ IGMP是Internet组管理协议，用来把一个UDP数据报多播到多个主机。
+ ARP和RARP是某些网络接口使用的特殊协议，用来转换IP层和网络接口层使用的地址。

### 互联网地址分类

互联网上的每个接口都必须有一个唯一的Internet地址，多个接口的主机具有多个IP地址。

IP地址由互联网络信息中心分配，它只分配物料号，主机号由系统管理员负责。

IP地址长度为32bit，通常通过「点分十进制」表示，主要有三种类型：单播地址、广播地址、多播地址。

### 域名系统

IP地址可以识别主机上的网络接口，进而访问主机。但IP地址并不利于人们记忆，人们更适合记忆主机名。TCP/IP领域，DNS是一个分布式数据库，用于实现IP地址到主机名之间的映射。

### 封装

应用程序使用TCP传输数据时，数据被送入协议栈，然后逐个通过每层知道被当作一串比特流送入网络。每一层对收到的数据添加一些首部信息：

+ TCP传送给IP的数据单元称为TCP报文段（TCP segment）；
+ UDP传送到IP的数据单元称为UDP数据包（UDP datagram）；
+ IP传送给网络接口层的数据单元称为IP数据报（IP datagram）；
+ 通过以太网传送的比特流称为帧（Frame）。

以太网数据帧的物理特性是其长度必须在 46～1500字节之间。

![image-20210905191451411](https://gitee.com/tobing/imagebed/raw/master/image-20210905191451411.png)

由于TCP、UDP、ICMP、IGMP都要先IP传送数据，IP层首部会通过协议域（8bit）对他们进行区别。

由于许多应用程序都使用TCP或UDP来传送数据，运输层协议报文首部会使用端口号（16bit）表示不同应用程序。

网络接口层分别发送和介绍IP、ARP和RARP数据，以太网帧首部通过帧类型域（16bit）来区别它们。

### 分用

当目的主机收到一个以太网数据帧时，数据就开始从协议栈中由底向上，同时去掉各层协议加上的报文首部。每一层协议会检查报文首部的协议标识，以确定接收数据的上层协议。这个过程称为「分用」。

![image-20210905192144048](https://gitee.com/tobing/imagebed/raw/master/image-20210905192144048.png)

需要注意，ICMP和IGMP虽然和IP位于同一层，但它们都被封装到IP数据报中。

对于ARP和RARP，它们属于链路层，但是都有各自的以太网帧数据类型。

### 客户-服务器模型

大多数网络层应用程序在编写时都假设一段是客户端，另一段是服务器，目的是让服务器为客户提供特定的服务。可以将服务分为两种类型：重复型或并发型。

+ 重复型：等待请求==>处理请求（不能为其他客户提供服务）==>响应请求==>等待请求
+ 并发型：等待请求==>启动新服务器处理请求（可以处理多个）==>响应请求

一般而言，TCP服务器是并发的，UDP服务器是重复的。

### 端口号

TCP和UDP采用16 bit的端口号来识别应用程序。其中：

+ 1~1023用于Unix提供特定的服务；
+ 1024～5000用于大多数TCP/IP实现临时的端口分配；
+ 大于5000端口号是为其他服务器预留



## 链路层

链路层主要有三个目的：

1. 为IP模块发送和介绍IP数据报；
2. 为ARP模块发送ARP请求和接收ARP应答；
3. 为ARP模块发送RARP请求和接收RARP应答；

TCP/IP支持多种不同的链路层协议，取决于网络使用的硬件，如以太网、令牌环网、FDDI以及RS-232串行线路等。

### 以太网

以太网是当今TCP/IP采用的主要的局域网技术，它采用一种CSMA/CD的媒体接入方法，速率为10Mb/s、地址为48bit。

+ CSMA/CD：带冲突检测的载波侦听多路接入
+ 48bit地址：我们常见的硬件地址，ARP和RARP对32bit的IP地址和48bit的硬件地址进行映射

### PPP

PPP，点对点协议，主要包含以下三部分：

1. 在串行链路上封装IP数据报的方法。PPP既支持数据为 8位和无奇偶检验的异步模式，还支持面向比特的同步链接。
2. 建立、配置以及测试数据链路的链路控制协议。允许通信双方进行协商，以确定不同的选项。
3. 针对不同网络层协议的网络控制协议。

PPP数据帧的格式如下：

![image-20210905194146553](https://gitee.com/tobing/imagebed/raw/master/image-20210905194146553.png)

+ 每一帧都以标志字符0x7E开始和结束

+ 紧接着是有个地址字节，是始终为0xff

+ 然后是有个值为0x33的控制字节

+ 接下来是协议字段，0x0021时，表示信息字段是一个IP数据报；0xC021时表示信息字段是链路控制数据；0x8021时表示信息字段是网络控制数据。

+ CRC字段是有一个循环冗余检测码，检测数据帧的错误。

用于0x7e是特殊字段，如果字符出现在信息字段，PPP会对它进行转义。

### MTU

以太网和802.3对数据帧长度都有限制，最大值分别是1500和1492字节。链路层把这个特性称为MTU，最大传送单元。

如果IP层有一个数据包要传输，而且数据长度比链路层的MTU大，IP层需要进行分片，把数据包分为若干片，每一片都小于MTU。点对点的链路层的MTU并非是网络媒体的网络特性，它只是一个逻辑限制，目的是为交互使用提供足够快的响应时间。

可以用netstat命令打印网络接口的MTU。

## IP

IP是TCP/IP协议中最核心的协议。所有TCP、UDP、ICMP和IGMP数据都以IP数据报格式传输。IP提供不可靠、无连接的数据传送服务。

+ 不可靠：不保证IP数据报能否成功到达目的地，IP仅提供最好的传输服务，如果发送错误，IP通常会丢弃该数据，并发送ICMP给信源端。
+ 无连接：IP不维护任何关于后继数据报的状态信息，每个数据包的处理是相互独立的。即IP数据报可以不按照发送顺序接收，每个数据报可以独立进行路由选择，可能选择不同线路。

### IP首部

IP数据报格式如下。普通IP首部长为20个字节，除非包含选项字段。

![image-20210905200802496](https://gitee.com/tobing/imagebed/raw/master/image-20210905200802496.png)

+ 协议版本号：4，表示为IPv4
+ 首部长度：指的是首部占 32 bit字的数目，包括任何选项。
+ 服务类型：最小时延、最大吞吐量、最高可靠性和最小费用。
+ 总长度字段：整个 IP数据报的长度，以字节为单位。利用首部长度和总长度可以计算出数据部分开始位置。IP最长可达65535字节。
+ 标识字段：唯一标识主机发送的每一份数据报。
+ TTL：设置数据报可以经过的最大路由器数，指定了数据报的生存时间。
+ 首部校验和：IP首部计算的校验和，不对数据进行计算。

### IP路由选择

概念上，IP路由选择是简单的，特别是对于主机。如果目的主机与源主机，直接相连或在一个共享网络，IP数据报就直接送到目标主机。否则主机把数据报发送一个默认的路由器，有路由器转发该数据报。





